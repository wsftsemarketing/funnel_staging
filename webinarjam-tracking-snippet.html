
<!-- Enhanced WebinarJam Tracking Snippet -->
<!-- Add this to your WebinarJam registration page AND webinar room page custom HTML/footer -->
<script>
// Initialize Mixpanel on WebinarJam pages
(function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(e,f,c){function g(a,d){var b=d.split(".");2==b.length&&(a=a[b[0]],d=b[1]);a[d]=function(){a.push([d].concat(Array.prototype.slice.call(arguments,0)))}}var a=b;"undefined"!==typeof c?a=b[c]=[]:c="mixpanel";a.people=a.people||[];a.toString=function(a){var d="mixpanel";"mixpanel"!==c&&(d+="."+c);a||(d+=" (stub)");return d};a.people.toString=function(){return a.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");for(h=0;h<i.length;h++)g(a,i[h]);var j="set set_once union unset remove delete".split(" ");a.get_group=function(){function b(c){d[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));a.push([e,call2])}}for(var d={},e=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<j.length;c++)b(j[c]);return d};b._i.push([e,f,c])};b.__SV=1.7}})(document,window.mixpanel||[]);

// Initialize with your token
mixpanel.init("79f20bfb126b3ffe57192638f36ee883");

// Enhanced cross-domain data retrieval from both URL and localStorage
function getCrossDomainData() {
  // First try localStorage (primary method)
  let crossDomainData = {};
  try {
    const storedData = localStorage.getItem('mp_cross_domain_data');
    if (storedData) {
      crossDomainData = JSON.parse(storedData);
    }
  } catch (e) {
    console.log('[Mixpanel] Error reading localStorage:', e);
  }

  // Fallback to URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const urlData = {
    mp_id: urlParams.get('mp_id'),
    mp_session: urlParams.get('mp_session'),
    mp_source: urlParams.get('mp_source'),
    mp_medium: urlParams.get('mp_medium'),
    mp_campaign: urlParams.get('mp_campaign'),
    mp_timestamp: urlParams.get('mp_timestamp')
  };

  // Merge localStorage and URL data (localStorage takes priority)
  const finalData = {
    mp_id: crossDomainData.mp_id || urlData.mp_id || 'unknown',
    mp_session: crossDomainData.mp_session || urlData.mp_session || 'unknown',
    mp_source: crossDomainData.mp_source || urlData.mp_source || 'direct',
    mp_medium: crossDomainData.mp_medium || urlData.mp_medium || 'organic',
    mp_campaign: crossDomainData.mp_campaign || urlData.mp_campaign || 'webinar',
    mp_timestamp: crossDomainData.mp_timestamp || urlData.mp_timestamp || Date.now()
  };

  // Store the final data back to localStorage for future use
  localStorage.setItem('mp_cross_domain_data', JSON.stringify(finalData));
  
  return finalData;
}

// Get cross-domain data and identify user
const crossDomainData = getCrossDomainData();
if (crossDomainData.mp_id !== 'unknown') {
  mixpanel.identify(crossDomainData.mp_id);
}

// Webinar Progress Tracking Class
class WebinarProgressTracker {
  constructor() {
    this.webinarHash = 'y86q9a7p'; // Your webinar hash
    this.startTime = Date.now();
    this.watchTime = 0;
    this.lastProgressCheck = Date.now();
    this.milestones = [10, 25, 50, 75, 90, 100]; // Percentage milestones
    this.trackedMilestones = new Set();
    this.isPlaying = false;
    this.totalDuration = 0;
    this.currentPosition = 0;
    
    this.initializeTracking();
  }

  initializeTracking() {
    // Detect page type
    const isRegistrationPage = window.location.href.includes('register') || 
                              document.querySelector('form') || 
                              window.location.pathname.includes('reg');
    
    const isWebinarRoom = window.location.href.includes('room') || 
                         window.location.href.includes('live') || 
                         document.querySelector('video') ||
                         window.location.pathname.includes('webinar');

    if (isRegistrationPage) {
      this.trackRegistrationPage();
    } else if (isWebinarRoom) {
      this.trackWebinarRoom();
    }
  }

  trackRegistrationPage() {
    mixpanel.track('Webinar Registration Page Viewed', {
      platform: 'webinarjam',
      webinar_hash: this.webinarHash,
      original_session: crossDomainData.mp_session,
      utm_source: crossDomainData.mp_source,
      utm_medium: crossDomainData.mp_medium,
      utm_campaign: crossDomainData.mp_campaign,
      page_url: window.location.href,
      cross_domain_source: 'localStorage'
    });

    // Track form interactions
    this.setupFormTracking();
  }

  trackWebinarRoom() {
    mixpanel.track('Webinar Room Entered', {
      platform: 'webinarjam',
      webinar_hash: this.webinarHash,
      original_session: crossDomainData.mp_session,
      utm_source: crossDomainData.mp_source,
      utm_medium: crossDomainData.mp_medium,
      utm_campaign: crossDomainData.mp_campaign,
      page_url: window.location.href,
      entry_time: new Date().toISOString()
    });

    // Setup video tracking
    this.setupVideoTracking();
    this.setupEngagementTracking();
  }

  setupFormTracking() {
    document.addEventListener('DOMContentLoaded', () => {
      const forms = document.querySelectorAll('form');
      forms.forEach(form => {
        // Track form start
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          input.addEventListener('focus', () => {
            mixpanel.track('Webinar Form Started', {
              platform: 'webinarjam',
              webinar_hash: this.webinarHash,
              original_session: crossDomainData.mp_session,
              form_field: input.name || input.type
            });
          }, { once: true });
        });

        // Track form submission
        form.addEventListener('submit', (e) => {
          const formData = new FormData(form);
          const name = formData.get('name') || formData.get('first_name') || '';
          const email = formData.get('email') || '';

          mixpanel.track('Webinar Registration Submitted', {
            platform: 'webinarjam',
            webinar_hash: this.webinarHash,
            original_session: crossDomainData.mp_session,
            utm_source: crossDomainData.mp_source,
            utm_medium: crossDomainData.mp_medium,
            utm_campaign: crossDomainData.mp_campaign,
            registrant_name: name,
            registrant_email: email,
            registration_time: new Date().toISOString()
          });

          // Set user properties
          mixpanel.people.set({
            $email: email,
            $name: name,
            webinar_registered: true,
            registration_source: 'webinarjam',
            webinar_hash: this.webinarHash
          });
        });
      });
    });

    // Track thank you page
    if (window.location.href.includes('thank') || 
        window.location.href.includes('success') || 
        window.location.href.includes('confirmation')) {
      mixpanel.track('Webinar Registration Confirmed', {
        platform: 'webinarjam',
        webinar_hash: this.webinarHash,
        original_session: crossDomainData.mp_session,
        confirmation_time: new Date().toISOString()
      });
    }
  }

  setupVideoTracking() {
    // Monitor for video elements (WebinarJam might use different video players)
    const checkForVideo = () => {
      const videos = document.querySelectorAll('video');
      const iframes = document.querySelectorAll('iframe[src*="webinarjam"], iframe[src*="everwebinar"]');
      
      if (videos.length > 0) {
        videos.forEach(video => this.attachVideoListeners(video));
      }
      
      if (iframes.length > 0) {
        this.setupIframeTracking(iframes);
      }
    };

    // Check immediately and periodically for video elements
    checkForVideo();
    setInterval(checkForVideo, 2000);

    // Manual progress tracking fallback
    this.setupManualProgressTracking();
  }

  attachVideoListeners(video) {
    video.addEventListener('loadedmetadata', () => {
      this.totalDuration = video.duration;
      mixpanel.track('Webinar Video Loaded', {
        platform: 'webinarjam',
        webinar_hash: this.webinarHash,
        video_duration: this.totalDuration,
        original_session: crossDomainData.mp_session
      });
    });

    video.addEventListener('play', () => {
      this.isPlaying = true;
      this.lastProgressCheck = Date.now();
      mixpanel.track('Webinar Playback Started', {
        platform: 'webinarjam',
        webinar_hash: this.webinarHash,
        play_position: video.currentTime,
        original_session: crossDomainData.mp_session
      });
    });

    video.addEventListener('pause', () => {
      this.isPlaying = false;
      this.updateWatchTime();
      mixpanel.track('Webinar Playback Paused', {
        platform: 'webinarjam',
        webinar_hash: this.webinarHash,
        pause_position: video.currentTime,
        watch_time: this.watchTime,
        original_session: crossDomainData.mp_session
      });
    });

    video.addEventListener('timeupdate', () => {
      this.currentPosition = video.currentTime;
      this.checkMilestones();
    });

    video.addEventListener('ended', () => {
      this.isPlaying = false;
      this.updateWatchTime();
      mixpanel.track('Webinar Completed', {
        platform: 'webinarjam',
        webinar_hash: this.webinarHash,
        total_watch_time: this.watchTime,
        completion_rate: 100,
        original_session: crossDomainData.mp_session
      });
    });
  }

  setupIframeTracking(iframes) {
    // For iframe-based players, we'll use URL monitoring and time-based estimation
    iframes.forEach(iframe => {
      mixpanel.track('Webinar Iframe Loaded', {
        platform: 'webinarjam',
        webinar_hash: this.webinarHash,
        iframe_src: iframe.src,
        original_session: crossDomainData.mp_session
      });
    });
  }

  setupManualProgressTracking() {
    // Time-based progress tracking as fallback
    setInterval(() => {
      if (this.isPlaying || this.isWebinarActive()) {
        this.updateWatchTime();
        this.checkTimeMilestones();
      }
    }, 10000); // Check every 10 seconds
  }

  setupEngagementTracking() {
    // Track chat interactions
    const observeChat = () => {
      const chatInputs = document.querySelectorAll('input[placeholder*="message"], textarea[placeholder*="message"], input[placeholder*="chat"], textarea[placeholder*="chat"]');
      chatInputs.forEach(input => {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            mixpanel.track('Webinar Chat Message Sent', {
              platform: 'webinarjam',
              webinar_hash: this.webinarHash,
              watch_time: this.watchTime,
              original_session: crossDomainData.mp_session
            });
          }
        });
      });
    };

    // Track button clicks (CTAs, polls, etc.)
    document.addEventListener('click', (e) => {
      const button = e.target.closest('button, .btn, [role="button"]');
      if (button) {
        const buttonText = button.textContent || button.value || 'Unknown';
        if (buttonText.toLowerCase().includes('buy') || 
            buttonText.toLowerCase().includes('purchase') || 
            buttonText.toLowerCase().includes('order') ||
            buttonText.toLowerCase().includes('get')) {
          
          mixpanel.track('Webinar CTA Clicked', {
            platform: 'webinarjam',
            webinar_hash: this.webinarHash,
            cta_text: buttonText,
            watch_time: this.watchTime,
            original_session: crossDomainData.mp_session
          });
        }
      }
    });

    setInterval(observeChat, 3000);
  }

  isWebinarActive() {
    // Detect if webinar is actively playing by looking for active indicators
    const playButtons = document.querySelectorAll('.play, .playing, [data-playing="true"]');
    const activeVideo = document.querySelector('video:not([paused])');
    return playButtons.length > 0 || activeVideo;
  }

  updateWatchTime() {
    if (this.isPlaying || this.isWebinarActive()) {
      const now = Date.now();
      this.watchTime += (now - this.lastProgressCheck) / 1000;
      this.lastProgressCheck = now;
    }
  }

  checkMilestones() {
    if (this.totalDuration > 0) {
      const progress = (this.currentPosition / this.totalDuration) * 100;
      this.trackProgressMilestone(progress);
    }
  }

  checkTimeMilestones() {
    // Time-based milestones (for when we can't get video duration)
    const timeBasedMilestones = [60, 300, 600, 1200, 1800, 2400]; // seconds: 1min, 5min, 10min, 20min, 30min, 40min
    timeBasedMilestones.forEach(milestone => {
      if (this.watchTime >= milestone && !this.trackedMilestones.has(`time_${milestone}`)) {
        this.trackedMilestones.add(`time_${milestone}`);
        mixpanel.track('Webinar Time Milestone', {
          platform: 'webinarjam',
          webinar_hash: this.webinarHash,
          milestone_seconds: milestone,
          milestone_minutes: Math.round(milestone / 60),
          total_watch_time: this.watchTime,
          original_session: crossDomainData.mp_session
        });
      }
    });
  }

  trackProgressMilestone(progress) {
    this.milestones.forEach(milestone => {
      if (progress >= milestone && !this.trackedMilestones.has(milestone)) {
        this.trackedMilestones.add(milestone);
        mixpanel.track('Webinar Progress Milestone', {
          platform: 'webinarjam',
          webinar_hash: this.webinarHash,
          progress_percentage: milestone,
          watch_time: this.watchTime,
          video_position: this.currentPosition,
          original_session: crossDomainData.mp_session,
          utm_source: crossDomainData.mp_source,
          utm_medium: crossDomainData.mp_medium,
          utm_campaign: crossDomainData.mp_campaign
        });
      }
    });
  }
}

// Initialize the tracker
document.addEventListener('DOMContentLoaded', () => {
  window.webinarTracker = new WebinarProgressTracker();
});

// Track page exit with final stats
window.addEventListener('beforeunload', () => {
  if (window.webinarTracker) {
    window.webinarTracker.updateWatchTime();
    
    // Use sendBeacon for reliable exit tracking
    const exitData = {
      event: 'Webinar Session Exit',
      properties: {
        platform: 'webinarjam',
        webinar_hash: window.webinarTracker.webinarHash,
        total_watch_time: window.webinarTracker.watchTime,
        session_duration: (Date.now() - window.webinarTracker.startTime) / 1000,
        milestones_reached: Array.from(window.webinarTracker.trackedMilestones),
        original_session: crossDomainData.mp_session,
        exit_time: new Date().toISOString()
      }
    };

    if (navigator.sendBeacon) {
      const payload = JSON.stringify(exitData);
      navigator.sendBeacon(
        `https://api.mixpanel.com/track?data=${btoa(payload)}&api_key=79f20bfb126b3ffe57192638f36ee883`
      );
    }
  }
});

console.log('[WebinarJam Tracking] Enhanced tracking initialized with progress monitoring');
</script>
